Build-wireguard-kpm-apatch:
  name: Build WireGuard KPM (apatch format)
  runs-on: ubuntu-latest
  needs: [Build-kpimg]  # 可选依赖：确保 kpimg 已构建（用于打包）

  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Parse version
      id: version
      run: |
        source <(grep -E '^#define' version | sed 's/#define\s\+\([A-Z_]\+\)\s\+\(.*\)/\1=\2/')
        echo "tag=v${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT
        echo "version=${MAJOR}.${MINOR}.${PATCH}" >> $GITHUB_OUTPUT

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libelf-dev linux-headers-$(uname -r) git

    - name: Clone WireGuard-Linux
      run: |
        git clone https://git.zx2c4.com/WireGuard-linux-compat src/wireguard-src
        mkdir -p wireguard-module
        cp -r src/wireguard-src/src/* wireguard-module/
        # 清理不需要的文件
        rm -f wireguard-module/{main,Makefile}

    - name: Write Makefile for WireGuard module
      run: |
        cat > wireguard-module/Makefile << 'EOF'
obj-m += main.o
main-y := noise.o handshake.o handshake_cookie.o peer.o timers.o device.o qdisc.o socket.o send.o receive.o netlink.o allowedips.o ratelimiter.o queueing.o debugfs.o selftest.o
ccflags-y += -I$(src)/uapi
EXTRA_CFLAGS += -DCONFIG_WIREGUARD_MODULE
KBUILD_EXTRA_SYMBOLS = ${PWD}/kpimg/kpimg.symvers
EOF

    - name: Copy UAPI headers
      run: |
        mkdir -p wireguard-module/uapi
        cp src/wireguard-src/uapi/*.h wireguard-module/uapi/

    - name: Build kpimg (if not already built)
      run: |
        mkdir -p kpimg
        make ARCH=arm64 CROSS_COMPILE=aarch64-none-elf- -C kpimg clean all

    - name: Build WireGuard .ko
      run: |
        make -C /lib/modules/$(uname -r)/build M=${PWD}/wireguard-module modules
        mv wireguard-module/main.ko wireguard.ko

    - name: Create apatch-style KPM package
      run: |
        mkdir -p wireguard-kpm/{metadata,modules}
        
        # 创建 metadata.json（关键！适配 apatch 格式）
        cat > wireguard-kpm/metadata/metadata.json << EOF
{
  "name": "wireguard",
  "version": "${{ steps.version.outputs.version }}",
  "author": "zx2c4",
  "description": "WireGuard Kernel Module for apatch",
  "kernel": "5.4+",
  "min_apatch": "1.0.0",
  "module_path": "modules/wireguard.ko",
  "auto_mount": true,
  "loader": "kpimg"
}
EOF

        # 复制 ko 文件
        cp wireguard.ko wireguard-kpm/modules/

        # 打包为 .kpm
        cd wireguard-kpm && zip -r ../wireguard.apatch.kpm ./*

    - name: Upload KPM Artifact
      uses: actions/upload-artifact@v3
      with:
        name: wireguard-kpm
        path: wireguard.apatch.kpm

    - name: Upload to GitHub Release
      uses: softprops/action-gh-release@v2
      if: github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main'
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: "Release ${{ steps.version.outputs.version }}"
        body: "Automated release with WireGuard KPM (apatch)"
        files: wireguard.apatch.kpm
        allow_updates: true
        replaces_artifacts: true
